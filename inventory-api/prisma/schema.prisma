generator client {
  provider        = "prisma-client-js"
  output          = "../generated/prisma"
  previewFeatures = ["postgresqlExtensions"]

}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [uuid_ossp(map: "uuid-ossp")]
}

// Types of actions recorded against an asset
enum AssetActionType {
  REPAIR
  MAINTENANCE
  HIRE
  END_OF_LIFE
  LOST
  STOLEN
  CHECK_IN
  CHECK_OUT
  TRANSFER
  STATUS_CHANGE
}

// Priority for service actions
enum ActionPriority {
  LOW
  NORMAL
  HIGH
  CRITICAL
}

model asset_logs {
  id       String    @id @default(dbgenerated("uuid_generate_v4()"))
  asset_id String?
  message  String?
  date     DateTime? @default(now()) @db.Timestamp(6)
  user_id  String?
  assets   assets?   @relation(fields: [asset_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users    users?    @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model asset_types {
  id         String              @id @default(dbgenerated("uuid_generate_v4()"))
  name       String
  image_url  String?
  created_at DateTime            @default(now()) @db.Timestamp(6)
  updated_at DateTime?           @updatedAt
  fields     asset_type_fields[]
  assets     assets[]
}

model assets {
  type_id           String?
  serial_number     String?
  model             String?
  description       String?
  assigned_to_id    String?
  status            String
  next_service_date DateTime?            @db.Date
  documentation_url String?
  image_url         String?
  last_updated      DateTime?            @default(now()) @db.Timestamp(6)
  last_changed_by   String?
  location          String?
  id                String               @id @default(dbgenerated("uuid_generate_v4()"))
  date_purchased    DateTime?            @db.Date
  notes             String?
  field_values      asset_field_values[]
  asset_logs        asset_logs[]
  users             users?               @relation("AssetAssignment", fields: [assigned_to_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  asset_types       asset_types?         @relation(fields: [type_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  actions           asset_actions[]
}

model asset_field_values {
  id                  String            @id @default(dbgenerated("uuid_generate_v4()"))
  asset_id            String
  asset_type_field_id String
  value               String?
  created_at          DateTime          @default(now()) @db.Timestamp(6)
  updated_at          DateTime          @updatedAt
  asset               assets            @relation(fields: [asset_id], references: [id], onDelete: Cascade)
  asset_type_field    asset_type_fields @relation(fields: [asset_type_field_id], references: [id], onDelete: NoAction)

  @@unique([asset_id, asset_type_field_id])
  @@index([asset_id])
  @@index([asset_type_field_id])
}

model asset_type_fields {
  id               String               @id @default(dbgenerated("uuid_generate_v4()"))
  asset_type_id    String
  field_type_id    String
  name             String
  slug             String
  description      String?
  is_required      Boolean              @default(false)
  default_value    String?
  options          Json?
  validation_rules Json?
  display_order    Int                  @default(0)
  created_at       DateTime             @default(now()) @db.Timestamp(6)
  updated_at       DateTime             @updatedAt
  field_values     asset_field_values[]
  asset_type       asset_types          @relation(fields: [asset_type_id], references: [id], onDelete: Cascade)
  field_type       field_types          @relation(fields: [field_type_id], references: [id], onDelete: NoAction)

  @@unique([asset_type_id, slug])
  @@index([asset_type_id])
}

model field_types {
  id                String              @id @default(dbgenerated("gen_random_uuid()"))
  name              String
  slug              String              @unique
  description       String?
  has_options       Boolean             @default(false)
  validation_rules  Json?
  created_at        DateTime            @default(now()) @db.Timestamp(6)
  updated_at        DateTime            @updatedAt
  asset_type_fields asset_type_fields[]

  @@map("field_types")
}

model users {
  id         String       @id @default(dbgenerated("uuid_generate_v4()"))
  name       String
  userassets String[]
  useremail  String?      @unique
  role       UserRole     @default(USER)
  created_at DateTime?    @default(now()) @db.Timestamptz(6)
  updated_at DateTime?    @default(now()) @updatedAt @db.Timestamptz(6)
  asset_logs asset_logs[]
  assets     assets[]     @relation("AssetAssignment")

  // Backrefs for action relations
  performed_actions asset_actions[] @relation("ActionPerformer")
  actions_from      asset_actions[] @relation("ActionFrom")
  actions_to        asset_actions[] @relation("ActionTo")
}

enum UserRole {
  USER
  ADMIN
}

// Structured record of actions performed on an asset
model asset_actions {
  id           String           @id @default(dbgenerated("uuid_generate_v4()"))
  asset_id     String
  type         AssetActionType
  data         Json?
  note         String?
  performed_by String?
  from_user_id String?
  to_user_id   String?
  occurred_at  DateTime         @default(now()) @db.Timestamp(6)

  asset     assets   @relation(fields: [asset_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  performer users?   @relation("ActionPerformer", fields: [performed_by], references: [id])
  from_user users?   @relation("ActionFrom", fields: [from_user_id], references: [id])
  to_user   users?   @relation("ActionTo", fields: [to_user_id], references: [id])
  details   asset_action_details?

  @@index([asset_id, occurred_at])
  @@index([type])
}

// Optional structured details per action (1:1) to enable reporting
model asset_action_details {
  id              String           @id @default(dbgenerated("uuid_generate_v4()"))
  action_id       String           @unique
  action_type     AssetActionType
  // Common
  date            DateTime?        @db.Date
  notes           String?
  // Service (Repair/Maintenance)
  summary         String?
  estimated_cost  Decimal?         @db.Decimal(10, 2)
  priority        ActionPriority?
  // Hire
  hire_to         String?
  hire_start      DateTime?        @db.Date
  hire_end        DateTime?        @db.Date
  hire_rate       Decimal?         @db.Decimal(10, 2)
  hire_project    String?
  hire_client     String?
  // End of Life
  eol_reason      String?
  // Lost / Stolen
  where_location  String?
  police_report   String?

  action asset_actions @relation(fields: [action_id], references: [id], onDelete: Cascade)
}
